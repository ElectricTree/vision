// POST /users

import { Prisma } from "@prisma/client";
import { RequestHandler } from "express";
import { Services, ArweaveSignatureTags, DocType } from "../types";
import { AddUserRequest, AddUserResponse } from "../common/server-api";

// TODO: add location
// TODO: add local time night vs. day
export function addUser({ prisma, arweave }: Services): RequestHandler {
  return async (req, res) => {
    const { walletId, name, twitterUsername, signature, essayTransactionId } =
      req.body as AddUserRequest;
    // TODO: validate request, maybe use autogenerated zod

    try {
      const result = await prisma.user.create({
        data: {
          id: walletId,
          name,
          twitterUsername,
          signature,
        },
      });

      // add to arweave
      const arweaveSignatureData: ArweaveSignatureTags = {
        walletId: result.id,
        docType: DocType.Signature,
        essayTransactionId,
      };

      // NOTE: this is the arweave signature ID format -- <essay transaction Id>-<walletId>
      const arweaveSignatureId = `${essayTransactionId}-${walletId}`;
      const doc = await arweave.addDocument(
        arweaveSignatureId,
        arweaveSignatureData,
        arweaveSignatureData as any
      );
      await prisma.user.update({
        where: { id: walletId },
        data: { transactionId: doc.txID },
      });

      res.json({ ...result, walletId: result.id } as AddUserResponse);
    } catch (err) {
      console.log(err);
      if (err instanceof Prisma.PrismaClientValidationError) {
        res
          .status(400)
          .json({ error: `Received invalid data. ${err.message}` });
        return;
      }
      res.status(400).json({ error: err.message });
    }
  };
}
